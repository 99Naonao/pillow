<!--pages/mine/mine.wxml-->
<view class="mine-bg">
  <nav-bar title="个人中心" showNavBtn="{{false}}"  bgColor="#0b2853" titleColor="#fff"/>
  <!-- 个人信息卡片 -->
  <view class="mine-card">
    <block wx:if="{{isLogin}}">
      <view class="user-profile-container">
        <view class="avatar-section" bindtap="editAvatar">
          <image class="mine-avatar" src="{{avatarUrl}}" mode="aspectFill"/>
          <image class="edit-icon" src="../../static/update.png"/>
        </view>
        <view class="user-info-section">
          <text class="user-id">{{userName}}</text>
        </view>
      </view>
    </block>
    <block wx:else>
      <view class="not-login-content" bindtap="goLogin">
        <view class="not-login-left">
          <text class="not-login-title">立即登录</text>
          <text class="not-login-tip">登录享受更多功能</text>
        </view>
        <image class="not-login-arrow" src="../../static/right.png"/>
      </view>
    </block>
  </view>

  <!-- 功能区卡片 -->
  <view class="mine-func-card">
    <view class="mine-func-row" bindtap="openContactModal">
      <view class="mine-func-left">
        <image class="mine-func-icon" src="../../static/warn.png"/>
        <view class="mine-func-text">
          <text class="mine-func-label">设置紧急联系人</text>
          <text class="mine-func-desc">保障您的健康</text>
        </view>
      </view>
      <image class="mine-arrow" src="../../static/right.png"/>
    </view>
    <view class="mine-func-row" bindtap="goRingSet">
      <view class="mine-func-left">
        <image class="mine-func-icon" src="../../static/ring_set.png"/>
        <view class="mine-func-text">
          <text class="mine-func-label">预警设置</text>
        </view>
      </view>
      <image class="mine-arrow" src="../../static/right.png"/>
    </view>
    <view class="mine-func-row" bindtap="onShowProtocol">
      <view class="mine-func-left">
        <image class="mine-func-icon" src="../../static/service.png"/>
        <view class="mine-func-text">
          <text class="mine-func-label">服务协议</text>
        </view>
      </view>
      <image class="mine-arrow" src="../../static/right.png"/>
    </view>
    <view class="mine-func-row" bindtap="onShowAbout">
      <view class="mine-func-left">
        <image class="mine-func-icon" src="../../static/info.png"/>
        <view class="mine-func-text">
          <text class="mine-func-label">用户协议</text>
        </view>
      </view>
      <image class="mine-arrow" src="../../static/right.png"/>
    </view>
    <view class="mine-func-row" bindtap="onShowPrivacy">
      <view class="mine-func-left">
        <image class="mine-func-icon" src="../../static/info.png"/>
        <view class="mine-func-text">
          <text class="mine-func-label">隐私政策</text>
        </view>
      </view>
      <image class="mine-arrow" src="../../static/right.png"/>
    </view>
  </view>

  <!-- 退出登录按钮 - 放置在页面底部 -->
  <view wx:if="{{isLogin}}" class="logout-container">
    <button class="mine-logout-btn" bindtap="logout">退出登录</button>
  </view>
</view>

<!-- 紧急联系人管理弹窗 -->
<view wx:if="{{showContactModal}}" class="contact-modal-mask">
  <view class="contact-modal">
    <view class="contact-modal-header">
      <view class="contact-modal-title">紧急联系人管理</view>
      <image class="contact-modal-close" src="../../static/close.png" bindtap="closeContactModal"/>
    </view>
    <view class="contact-list">
      <block wx:for="{{emergencyContacts}}" wx:key="index">
        <view class="contact-item">
          <text class="contact-phone">{{item}}</text>
          <button class="contact-delete-btn" bindtap="deleteContact" data-index="{{index}}">删除</button>
        </view>
      </block>
      <view wx:if="{{emergencyContacts.length === 0}}" class="no-contacts">
        <text>暂无紧急联系人</text>
      </view>
    </view>
    <view class="contact-modal-btns">
      <button class="contact-modal-btn add" bindtap="addContact">添加联系人</button>
      <button class="contact-modal-btn cancel" bindtap="closeContactModal">完成</button>
    </view>
  </view>
</view>

<!-- 添加联系人弹窗 -->
<view wx:if="{{showAddContactModal}}" class="phone-modal-mask">
  <view class="phone-modal">
    <view class="phone-modal-title">添加紧急联系人</view>
    <input class="phone-modal-input" type="number" maxlength="11" placeholder="请输入手机号" value="{{phoneInput}}" bindinput="onPhoneInput"/>
    <view class="phone-modal-btns">
      <button class="phone-modal-btn cancel" bindtap="onAddContactCancel">取消</button>
      <button class="phone-modal-btn confirm" bindtap="onAddContactConfirm">确定</button>
    </view>
  </view>
</view>

  <!-- 新的头像昵称获取弹窗 -->
  <view wx:if="{{showNewAvatarModal}}" class="new-avatar-modal-mask" bindtap="closeNewAvatarModal">
    <view class="new-avatar-modal" catchtap="stopPropagation">
      <view class="new-avatar-modal-header">
        <view class="new-avatar-modal-title">设置头像和昵称</view>
        <view class="new-avatar-modal-close" bindtap="closeNewAvatarModal">✕</view>
      </view>
      <view class="new-avatar-content">
        <!-- 头像选择 -->
        <view class="modal-avatar-section">
          <text class="modal-section-title">选择头像</text>
          <button class="modal-avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
            <image class="modal-avatar" src="{{tempUserInfo.avatarUrl}}"></image>
            <view class="modal-avatar-overlay">
              <text class="modal-avatar-text">点击选择</text>
            </view>
          </button>
        </view>
        
        <!-- 昵称输入 -->
        <view class="nickname-section">
          <text class="section-title">设置昵称</text>
          <view class="nickname-wrapper">
            <input type="nickname" 
                   class="nickname-input" 
                   placeholder="请输入昵称" 
                   bind:change="onInputChange"
                   value="{{tempUserInfo.nickName}}" />
          </view>
        </view>
      </view>
      <view class="new-avatar-modal-btns">
        <button class="new-avatar-modal-btn cancel" bindtap="closeNewAvatarModal">取消</button>
        <button class="new-avatar-modal-btn confirm" bindtap="saveNewUserInfo">确定</button>
      </view>
    </view>
  </view>

<!-- 协议查看器组件 -->
<protocol-viewer 
  protocolType="{{currentProtocolType}}"
  visible="{{showProtocolViewer}}"
  bind:close="onCloseProtocolViewer"
/>