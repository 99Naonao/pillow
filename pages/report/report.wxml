<view class="report-container">
  <!-- 顶部导航栏 -->
  <nav-bar title="睡眠报告" showNavBtn="{{false}}" bgColor="#083869" titleColor="#fff"/>
  <view class="report-header">
    <view class="date-row">
      <picker mode="date" value="{{calendarValue}}" bindchange="onDateChange">
        <view class="date-picker-inline">
          <text class="report-date">{{currentDate}}</text>
          <image src="../../static/calendar.png" class="icon-calendar"/>
        </view>
      </picker>
    </view>
  </view>

  <!-- TDesign 日历弹窗 -->
  <t-calendar
    visible="{{showCalendar}}"
    value="{{calendarValue}}"
    mode="single"
    bind:close="onCalendarClose"
    bind:confirm="onCalendarConfirm"
  />

  <scroll-view scroll-y="true" class="report-scroll-content">
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在加载数据...</text>
    </view>
    
    <!-- 睡眠时长与评分 -->
    <view class="summary-row">
      <view class="sleep-duration">
        <text class="duration-title">本次睡眠时长</text>
        <text class="duration-value">{{sleepTime}}</text>   
        <view class="time-block">
          <view class="time-row">
            <image src="../../static/moon.png" class="icon-time"/>
            <text class="time-label">开始时间</text>
            <text class="time-value">{{sleepStartTime}}</text>
          </view>
          <view class="time-divider"></view>
          <view class="time-row">
            <image src="../../static/sun.png" class="icon-time"/>
            <text class="time-label">结束时间</text>
            <text class="time-value">{{sleepEndTime}}</text>
          </view>
        </view>
      </view>
      <view class="score-circle-wrap">
        <ec-canvas wx:if="{{scoreCircleChart}}" id="scoreCircleChart" canvas-id="scoreCircleChart" ec="{{scoreCircleChart}}" class="score-circle-canvas"></ec-canvas>
        <view class="circle-score-abs">
          <!-- <text class="score-title">睡眠质量</text>
          <text class="score-level">良好</text> -->
          <text class="score-label">综合评分</text>
          <text class="score-value">{{sleepScore}}</text>
          <text class="score-level">{{scoreLevel}}</text>
        </view>
      </view>
    </view>

    <!-- 睡眠分期饼图与比例 -->
    <view class="stage-row">
      <view class="stage-pie">
        <ec-canvas wx:if="{{stagePieChart}}" id="stagePieChart" canvas-id="stagePieChart" ec="{{stagePieChart}}"></ec-canvas>
      </view>
      <view class="stage-legend-box">
        <view class="stage-legend">
          <view class="legend-row">
            <view class="legend-dot shallow"></view>
            <text>浅睡期</text>
            <text class="legend-percent">{{shallowPercent}}%</text>
          </view>
          <view class="legend-row">
            <view class="legend-dot rem"></view>
            <text>快速眼动</text>
            <text class="legend-percent">{{remPercent}}%</text>
          </view>
          <view class="legend-row">
            <view class="legend-dot deep"></view>
            <text>深睡期</text>
            <text class="legend-percent">{{deepPercent}}%</text>
          </view>
          <view class="legend-row">
            <view class="legend-dot awake"></view>
            <text>清醒期</text>
            <text class="legend-percent">{{awakePercent}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 心率趋势图 -->
    <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/heart_rate.png" class="trend-icon"/>
        <text class="trend-title">平均心率</text>
        <text class="trend-value">{{heartRate}}</text>
      </view>
      <ec-canvas wx:if="{{heartTrendChart}}" id="heartTrendChart" canvas-id="heartTrendChart" ec="{{heartTrendChart}}"></ec-canvas>
    </view>

    <!-- 呼吸频率趋势图 -->
    <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/breath.png" class="trend-icon"/>
        <text class="trend-title">平均呼吸频率</text>
        <text class="trend-value">{{breathRate}}</text>
      </view>
      <ec-canvas wx:if="{{breathTrendChart}}" id="breathTrendChart" canvas-id="breathTrendChart" ec="{{breathTrendChart}}"></ec-canvas>
    </view>

    <!-- 体动次数趋势图 -->
    <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/turn_over.png" class="trend-icon"/>
        <text class="trend-title">累积体动</text>
        <text class="trend-value">{{turnCount}}</text>
      </view>
      <ec-canvas wx:if="{{bodyMoveTrendChart}}" id="bodyMoveTrendChart" canvas-id="bodyMoveTrendChart" ec="{{bodyMoveTrendChart}}"></ec-canvas>
    </view>

    <!-- 打鼾信息 -->
    <!-- <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/warn.png" class="trend-icon"/>
        <text class="trend-title">打鼾情况</text>
        <text class="trend-value">{{snoreCount}}次</text>
      </view>
      <view class="snore-info">
        <text class="snore-duration">打鼾时长: {{snoreDuration}}分钟</text>
      </view>
    </view> -->

    <!-- 睡眠评估 -->
    <view class="trend-card" wx:if="{{sleepAssessment}}">
      <view class="trend-header">
        <image src="../../static/info.png" class="trend-icon"/>
        <text class="trend-title">睡眠评估</text>
      </view>
      <view class="assessment-content">
        <text class="assessment-text">{{sleepAssessment}}</text>
      </view>
    </view>

    <!-- 睡眠年龄 -->
    <view class="trend-card" wx:if="{{sleepAge > 0}}">
      <view class="trend-header">
        <image src="../../static/score.png" class="trend-icon"/>
        <text class="trend-title">睡眠年龄</text>
        <text class="trend-value">{{sleepAge}}岁</text>
      </view>
    </view>

    <!-- 入睡时间 -->
    <view class="trend-card" wx:if="{{sleepOnsetTime > 0}}">
      <view class="trend-header">
        <image src="../../static/moon.png" class="trend-icon"/>
        <text class="trend-title">入睡时间</text>
        <text class="trend-value">{{sleepOnsetTime}}分钟</text>
      </view>
    </view>

    <!-- 睡眠建议 -->
    <view class="trend-card" wx:if="{{advice}}">
      <view class="trend-header">
        <image src="../../static/service.png" class="trend-icon"/>
        <text class="trend-title">睡眠建议</text>
      </view>
      <view class="advice-content">
        <text class="advice-text">{{advice}}</text>
      </view>
    </view>
  </scroll-view>
</view>