<view class="report-container">
  <!-- 顶部导航栏 -->
  <nav-bar title="睡眠报告" showNavBtn="{{false}}" bgColor="#0b2853" titleColor="#fff"/>
  <view class="report-header">
    <view class="date-row">
      <picker mode="date" value="{{calendarValue}}" bindchange="onDateChange">
        <view class="date-picker-inline">
          <text class="report-date">{{currentDate}}</text>
          <image src="../../static/calendar.png" class="icon-calendar"/>
        </view>
      </picker>
    </view>
  </view>

  <scroll-view scroll-y="true" class="report-scroll-content">
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在加载数据...</text>
    </view>
    
    <!-- 睡眠时长与评分 -->
    <view class="summary-row">
      <view class="sleep-duration">
        <text class="duration-title">本次睡眠时长</text>
        <text class="duration-value">{{sleepTime}}</text>   
        <view class="time-block">
          <view class="time-row">
            <image src="../../static/moon.png" class="icon-time"/>
            <text class="time-label">开始时间</text>
            <text class="time-value">{{sleepStartTime}}</text>
          </view>
          <view class="time-divider"></view>
          <view class="time-row">
            <image src="../../static/sun.png" class="icon-time"/>
            <text class="time-label">结束时间</text>
            <text class="time-value">{{sleepEndTime}}</text>
          </view>
        </view>
      </view>
      <view class="score-circle-wrap">
        <ec-canvas wx:if="{{scoreCircleChart}}" id="scoreCircleChart" canvas-id="scoreCircleChart" ec="{{scoreCircleChart}}" class="score-circle-canvas"></ec-canvas>
        <view class="circle-score-abs">
          <!-- <text class="score-title">睡眠质量</text>
          <text class="score-level">良好</text> -->
          <text class="score-label">综合评分</text>
          <text class="score-value">{{sleepScore}}</text>
          <text class="score-level">{{scoreLevel}}</text>
        </view>
      </view>
    </view>

    <!-- 睡眠阶段时间线 -->
    <view class="sleep-timeline-container">
      <view class="timeline-wrapper">
        <!-- 使用純 CSS 實現睡眠階段多行塊狀圖 -->
        <view class="sleep-chart-header">
          <text class="chart-title">睡眠阶段</text>
          <text class="chart-subtitle">{{sleepStartTime}} - {{sleepEndTime}}</text>
        </view>
        
        <view class="sleep-timeline-chart">
          <!-- 時間軸標籤 -->
          <!-- <view class="time-axis">
            <view class="time-label" wx:for="{{sleepTimeLabels}}" wx:key="index" style="left: {{item.position}}%">
              <text>{{item.time}}</text>
            </view>
          </view> -->
          
          <!-- 睡眠階段區域 -->
          <view class="sleep-stages">
            <view class="sleep-stage" wx:for="{{sleepStages}}" wx:key="name">
              <view class="stage-label">{{item.name}}</view>
              <view class="stage-timeline">
                <view 
                  class="stage-block" 
                  wx:for="{{item.blocks}}" 
                  wx:key="index"
                  style="left: {{item.left}}%; width: {{item.width}}%; background-color: {{item.color}};"
                  data-stage="{{item.stage}}"
                  data-start="{{item.startTime}}"
                  data-end="{{item.endTime}}"
                  data-duration="{{item.duration}}"
                  bindtap="onStageBlockTap">
                </view>
                
                <!-- 在對應的睡眠階段塊旁邊顯示信息框 -->
                <view 
                  class="block-info-popup" 
                  wx:if="{{showBlockInfo && selectedBlock.stage === item.name}}" 
                  style="left: {{selectedBlock.left}}%; top: 0;"
                  bindtap="closeBlockInfo">
                  <view class="trend-card compact-info" catchtap="">
                    <view class="trend-header">
                      <image src="../../static/info.png" class="trend-icon"/>
                      <text class="trend-title">{{selectedBlock.stage}} 详情</text>
                      <view class="block-info-close" bindtap="closeBlockInfo">
                        <text>×</text>
                      </view>
                    </view>
                    <view class="block-info-content">
                      <view class="block-info-item">
                        <text class="block-info-label">开始时间</text>
                        <text class="block-info-value">{{selectedBlock.startTime}}</text>
                      </view>
                      <view class="block-info-item">
                        <text class="block-info-label">结束时间</text>
                        <text class="block-info-value">{{selectedBlock.endTime}}</text>
                      </view>
                      <view class="block-info-item">
                        <text class="block-info-label">持续时长</text>
                        <text class="block-info-value">{{selectedBlock.duration}} 分钟</text>
                      </view>
                    </view>
                  </view>
                </view>
                
              </view>
            </view>
          </view>
        </view>
        
        
        <!-- 柱状图（旧样式，暂时保留在多行图下方） -->
        <view class="sleep-chart-container">
          <view class="chart-header">
            <text class="chart-title">睡眠时间线</text>

          </view>

          <view class="chart-bars" bindtap="onChartBarTap">
            <view 
              class="chart-bar {{item.type}}" 
              wx:for="{{sleepChartData}}" 
              wx:key="index"
              data-index="{{index}}"
              data-time="{{item.time}}"
              data-type="{{item.type}}"
              style="width: {{item.width}}%; left: {{item.left}}%"
            >
              <view class="bar-content">
                <text class="bar-time">{{item.time}}</text>
                <text class="bar-duration" wx:if="{{item.duration}}" style="font-size: {{item.fontSize}}rpx;">{{item.duration}}</text>
                <text class="bar-end-time" wx:if="{{item.endTime}}">{{item.endTime}}</text>
              </view>
            </view>
          </view>
        </view>
        

        <view class="timeline-bar">
          <view class="timeline-segment offbed" wx:if="{{offbedPercent > 0}}" style="width: {{offbedPercent}}%"></view>
          <view class="timeline-segment awake" style="width: {{awakePercent}}%"></view>
          <view class="timeline-segment shallow" style="width: {{shallowPercent}}%"></view>
          <view class="timeline-segment deep" style="width: {{deepPercent}}%"></view>
        </view>

        <view class="timeline-labels">
          <view class="timeline-label offbed" wx:if="{{offbedPercent > 0}}" style="width: {{offbedPercent}}%">
            <text class="label-text">离床</text>
            <text class="label-duration">{{offbedDuration}}小时</text>
          </view>
          <view class="timeline-label awake" style="width: {{awakePercent}}%">
            <text class="label-text">清醒</text>
            <text class="label-duration">{{awakeDuration}}小时</text>
          </view>
          <view class="timeline-label shallow" style="width: {{shallowPercent}}%">
            <text class="label-text">浅睡</text>
            <text class="label-duration">{{shallowDuration}}小时</text>
          </view>
          <view class="timeline-label deep" style="width: {{deepPercent}}%">
            <text class="label-text">深睡</text>
            <text class="label-duration">{{deepDuration}}小时</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 心率趋势图 -->
    <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/heart_rate.png" class="trend-icon"/>
        <text class="trend-title">平均心率</text>
        <text class="trend-value">{{heartRate}}</text>
      </view>
      <ec-canvas wx:if="{{heartTrendChart}}" id="heartTrendChart" canvas-id="heartTrendChart" ec="{{heartTrendChart}}"></ec-canvas>
    </view>

    <!-- 呼吸频率趋势图 -->
    <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/breath.png" class="trend-icon"/>
        <text class="trend-title">平均呼吸频率</text>
        <text class="trend-value">{{breathRate}}</text>
      </view>
      <ec-canvas wx:if="{{breathTrendChart}}" id="breathTrendChart" canvas-id="breathTrendChart" ec="{{breathTrendChart}}"></ec-canvas>
    </view>

    <!-- 体动次数趋势图 -->
    <view class="trend-card">
      <view class="trend-header">
        <image src="../../static/turn_over.png" class="trend-icon"/>
        <text class="trend-title">累积体动</text>
        <text class="trend-value">{{turnCount}}</text>
      </view>
      <ec-canvas wx:if="{{bodyMoveTrendChart}}" id="bodyMoveTrendChart" canvas-id="bodyMoveTrendChart" ec="{{bodyMoveTrendChart}}"></ec-canvas>
    </view>

    <!-- 睡眠评估 -->
    <view class="trend-card" wx:if="{{sleepAssessment}}">
      <view class="trend-header">
        <image src="../../static/info.png" class="trend-icon"/>
        <text class="trend-title">睡眠评估</text>
      </view>
      <view class="assessment-content">
        <text class="assessment-text">{{sleepAssessment}}</text>
      </view>
    </view>



    <!-- 入睡时间 -->
    <view class="trend-card" wx:if="{{sleepOnsetTime > 0}}">
      <view class="trend-header">
        <image src="../../static/moon.png" class="trend-icon"/>
        <text class="trend-title">入睡时间</text>
        <text class="trend-value">{{sleepOnsetTime}}分钟</text>
      </view>
    </view>

    <!-- 睡眠建议 -->
    <view class="trend-card" wx:if="{{advice}}">
      <view class="trend-header">
        <image src="../../static/service.png" class="trend-icon"/>
        <text class="trend-title">睡眠建议</text>
      </view>
      <view class="advice-content">
        <text class="advice-text">{{advice}}</text>
      </view>
    </view>

    <!-- 前往商城 -->
    <view class="shop-section">
      <view class="shop-card">
        <view class="shop-header">
          <image src="../../static/shopping.png" class="shop-icon"/>
          <text class="shop-title">健康商城</text>
        </view>
        <view class="shop-content">
          <text class="shop-desc">发现更多健康产品，提升睡眠质量</text>
          <button class="shop-btn" bindtap="goToShop">前往商城</button>
        </view>
      </view>
    </view>
  </scroll-view>
</view>