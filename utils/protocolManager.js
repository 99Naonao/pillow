/**
 * 协议管理工具类
 * 用于管理服务协议、用户协议和隐私政策
 */
class ProtocolManager {
  constructor() {
    this.protocols = {
      service: {
        title: '服务协议',
        filename: 'service.txt',
        content: ''
      },
      user: {
        title: '用户协议',
        filename: 'user.txt',
        content: ''
      },
      privacy: {
        title: '隐私政策',
        filename: 'privacy.txt',
        content: ''
      }
    };
  }

  /**
   * 获取协议内容
   * @param {string} type - 协议类型：'service', 'user', 'privacy'
   * @returns {Promise<string>} 协议内容
   */
  async getProtocolContent(type) {
    if (!this.protocols[type]) {
      throw new Error(`不支持的协议类型: ${type}`);
    }

    try {
      // 如果已经加载过内容，直接返回
      if (this.protocols[type].content) {
        return this.protocols[type].content;
      }

      // 读取文件内容
      const content = await this.readFileContent(this.protocols[type].filename);
      this.protocols[type].content = content;
      return content;
    } catch (error) {
      console.error(`读取协议文件失败: ${error.message}`);
      throw error;
    }
  }

  /**
   * 读取文件内容
   * @param {string} filename - 文件名
   * @returns {Promise<string>} 文件内容
   */
  readFileContent(filename) {
    return new Promise((resolve, reject) => {
      // 由于微信小程序的限制，我们需要将协议内容直接嵌入到代码中
      // 这里包含了您三个协议文件的完整内容
      const contentMap = {
        'service.txt': `一、总则
本服务协议（以下简称 "本协议"）是您（以下简称 "用户"）与 [中数（福建）医疗科技有限公司]（以下简称 "开发者"）之间就 [小程序名称]（以下简称 "本小程序"）所提供的各项服务（以下简称 "本服务"）所订立的具有法律约束力的协议。
用户在使用本服务前，应仔细阅读并充分理解本协议的全部条款，特别是涉及用户权利义务的条款、限制或免责条款等。用户点击 "同意" 或实际使用本服务，即表示用户已接受本协议的全部内容，愿意受本协议约束。
开发者有权根据业务发展、技术更新及法律法规的变化，对本协议进行修改。修改后的协议将在本小程序内以公告等形式公示，公示期满后即生效。用户如继续使用本服务，视为接受修改后的协议；如不接受，应立即停止使用本服务。
二、服务内容与范围
本小程序提供的服务内容包括但不限于 [实时心率、实时呼吸率、睡眠报告等]，具体服务内容以本小程序实际提供的为准。
开发者有权根据自身业务安排，对本服务的内容、形式、功能等进行调整、更新或优化，如有重大变更，将通过本小程序公告等方式通知用户。
本服务仅供用户个人或合法的非商业用途使用，未经开发者书面许可，用户不得将本服务用于任何商业目的，包括但不限于转售、出租、授权他人使用等。
三、用户使用规范
用户在使用本服务时，应遵守国家法律法规、部门规章、行业规范以及社会公德，不得利用本服务从事任何违法违规活动。
用户应妥善保管自己的账号信息（包括账号名、密码等），对通过其账号实施的所有行为负责。如发现账号异常使用或被盗等情况，应立即通知开发者并采取相应措施，开发者将在合理范围内协助用户处理。
用户在使用本服务过程中，不得实施下列行为：
违反国家网络安全相关法律法规，危害网络安全的；
侵犯其他用户或第三方的合法权益，包括但不限于名誉权、隐私权、知识产权等；
发布、传播虚假信息、谣言、淫秽色情信息、暴力恐怖信息等有害内容的；
干扰、破坏本小程序的正常运行，或对本小程序进行反向工程、破解、篡改等的；
其他违反本协议或开发者合理要求的行为。
四、双方权利与义务
（一）开发者的权利与义务
开发者有权按照本协议的约定向用户提供本服务，并对本服务进行管理、维护和升级。
开发者应采取合理的技术措施和管理措施，保障本服务的正常运行和用户信息的安全，但不保证本服务完全无故障或绝对安全。
开发者有权对用户的使用行为进行监督，如发现用户违反本协议或法律法规的规定，有权采取警告、限制使用、暂停服务、注销账号等措施。
开发者应按照本协议及相关法律法规的规定，保护用户的个人信息，具体详见《[眠加智能观心枕] 隐私政策》。
（二）用户的权利与义务
用户有权按照本协议的约定使用本服务，对本服务的内容和功能有知情权和建议权。
用户应按照本协议的约定和开发者的要求，提供真实、准确、完整的信息，并及时更新相关信息。
用户应遵守本协议及开发者发布的各项规则，合理使用本服务，不得损害开发者或其他用户的合法权益。
用户应自行承担因使用本服务所产生的费用，包括但不限于网络流量费、数据存储费等。
五、服务的变更、中断与终止
开发者有权根据业务发展需要，对本服务进行变更，包括但不限于增加、减少服务内容、调整服务收费标准等。如服务变更影响用户的核心权益，开发者将提前通知用户，用户有权选择是否继续使用。
因系统维护、升级、故障、第三方服务中断等原因，可能导致本服务临时中断，开发者将尽可能提前通知用户，并尽快恢复服务。
发生下列情形之一的，开发者有权终止向用户提供本服务：
用户违反本协议的约定，经开发者通知后在合理期限内仍未改正的；
用户以欺诈、盗用等非法手段使用本服务的；
用户的账号长期未使用，且符合开发者规定的注销条件的；
法律法规规定或国家机关要求的其他情形。
本服务终止后，开发者将根据相关法律法规的规定处理用户的信息和数据，但不承担因服务终止给用户造成的任何损失，除非该损失是由于开发者的故意或重大过失造成的。
六、知识产权
本小程序及本服务所涉及的全部知识产权，包括但不限于软件、程序、文字、图片、音频、视频、商标、专利等，均归开发者或相关权利人所有。
用户在使用本服务过程中产生的内容（如发布的评论、上传的图片等），其知识产权归用户所有，但用户授予开发者一项全球范围内、免费、非独占、可转授权的许可，允许开发者在本服务及相关推广活动中使用、复制、传播、修改、汇编该等内容。
未经开发者或相关权利人书面许可，用户不得擅自使用、侵犯本小程序及本服务所涉及的知识产权。
七、免责条款
开发者仅对本协议中明确约定的义务承担责任，对因不可抗力、第三方原因、用户自身原因等导致的服务中断、数据丢失、损失等，不承担责任，但应尽力协助用户减少损失。
本服务可能包含链接到第三方网站或服务的内容，开发者对该等第三方网站或服务的内容、安全性等不承担责任，用户访问该等网站或服务应自行承担风险。
开发者对本服务的稳定性、可靠性、及时性等不作任何明示或暗示的保证，用户使用本服务所产生的风险由用户自行承担。
八、法律适用与争议解决
本协议的订立、效力、解释、履行及争议解决均适用中华人民共和国法律（不包括香港、澳门特别行政区和台湾地区的法律）。
因本协议引起的或与本协议有关的任何争议，双方应首先通过友好协商解决；协商不成的，任何一方均有权向开发者所在地有管辖权的人民法院提起诉讼。
九、其他
本协议构成双方关于本服务的完整协议，取代双方此前就本服务达成的任何口头或书面协议、谅解和承诺。
如本协议的任何条款被认定为无效或不可执行，不影响其他条款的效力。
开发者未行使或延迟行使其在本协议项下的任何权利，不应视为对该等权利的放弃。
如用户对本协议有任何疑问，可通过 [400-808-5180] 与开发者联系。
本协议自用户点击 "同意" 或实际使用本服务之日起生效。`,
        'user.txt': `一、总则
本用户协议（以下简称 "本协议"）是您（以下简称 "用户"）与 [中数（福建）医疗科技有限公司]（以下简称 "开发者"）之间关于使用 [眠加智能观心枕]（以下简称 "本小程序"）所订立的协议。
用户在使用本小程序前，应仔细阅读并充分理解本协议的全部条款，特别是涉及用户权利义务的条款、免责条款等。用户点击 "同意" 或使用本小程序，即表示用户已接受本协议的全部内容，愿意受本协议约束。
开发者有权根据业务发展和法律法规的变化，对本协议进行修改。修改后的协议将在本小程序内公示，公示后即生效。用户如继续使用本小程序，视为接受修改后的协议；如不接受，应停止使用本小程序。
二、用户账号
账号注册：用户在使用本小程序的部分功能时，可能需要注册账号。用户应提供真实、准确、完整的信息，包括但不限于手机号码、电子邮箱等，并及时更新相关信息。因用户提供的信息不实、不准确或不完整导致的一切后果，由用户自行承担。
账号安全：用户应对其账号及密码的安全负责，不得将账号及密码泄露给他人。如因用户自身原因导致账号被盗用、冒用等，由此产生的损失由用户自行承担。用户发现账号异常时，应及时通知开发者，开发者将协助用户采取相应措施。
账号注销：用户有权向开发者申请注销其账号。账号注销后，与该账号相关的所有数据可能会被删除，且无法恢复，用户应谨慎操作。
三、许可范围
开发者授予用户一项非独占、不可转让的许可，允许用户在本协议规定的范围内使用本小程序。
用户仅可出于个人或非商业目的使用本小程序，不得用于任何非法活动或侵犯开发者及第三方合法权益的活动。
未经开发者书面许可，用户不得对本小程序进行任何形式的修改、反向工程、反向编译、破解等操作，不得复制、传播、出租、出售本小程序及相关内容。
四、用户行为规范
用户在使用本小程序时，应遵守国家法律法规、社会公德和公序良俗，不得制作、发布、传播含有下列内容的信息：
违反宪法确定的基本原则的；
危害国家安全、泄露国家秘密、颠覆国家政权、破坏国家统一的；
损害国家荣誉和利益的；
煽动民族仇恨、民族歧视，破坏民族团结的；
破坏国家宗教政策，宣扬邪教和封建迷信的；
散布谣言，扰乱社会秩序，破坏社会稳定的；
散布淫秽、色情、赌博、暴力、恐怖或者教唆犯罪的；
侮辱或者诽谤他人，侵害他人合法权益的；
含有法律、行政法规禁止的其他内容的。
用户不得利用本小程序从事任何危害网络安全的活动，包括但不限于制作、传播计算机病毒、木马等恶意程序，攻击、侵入他人计算机系统等。
用户应尊重其他用户的合法权益，不得恶意骚扰、诽谤、辱骂其他用户。
五、知识产权
本小程序的所有内容，包括但不限于文字、图片、音频、视频、软件、程序、设计等，均由开发者或相关权利人拥有知识产权。
未经开发者或相关权利人书面许可，用户不得擅自使用、复制、传播、修改、汇编、出版本小程序的任何内容。
用户在本小程序上发布的内容，其知识产权归用户所有，但用户授予开发者一项全球范围内、免费、非独占的许可，允许开发者在本小程序及相关服务中使用、复制、传播、修改、汇编、出版该等内容。
六、隐私保护
开发者重视用户的隐私保护，将按照《隐私政策》的规定收集、使用、存储和保护用户的个人信息。
《隐私政策》是本协议的组成部分，与本协议具有同等法律效力。用户在使用本小程序前，应仔细阅读《隐私政策》。
七、免责条款
本小程序提供的服务是基于现有技术和条件的，开发者尽力保证服务的稳定性和可靠性，但不对服务的不间断性、及时性、安全性作出任何明示或暗示的保证。
因不可抗力、第三方原因等导致本小程序无法正常提供服务的，开发者不承担责任，但应及时通知用户并采取相应的补救措施。
用户因使用本小程序或依赖本小程序中的信息而导致的任何损失，包括但不限于直接损失、间接损失等，开发者不承担责任，除非该等损失是由于开发者的故意或重大过失造成的。
开发者对本小程序中链接的第三方网站或服务不承担责任，用户访问该等网站或服务时，应遵守其相应的条款和规定。
八、法律适用与争议解决
本协议的订立、效力、解释、履行及争议解决均适用中华人民共和国法律（不包括香港、澳门特别行政区和台湾地区的法律）。
因本协议引起的或与本协议有关的任何争议，双方应首先通过友好协商解决；协商不成的，任何一方均有权向开发者所在地有管辖权的人民法院提起诉讼。
九、其他
本协议构成双方关于使用本小程序的完整协议，取代双方此前就相关事项达成的任何口头或书面协议。
如本协议的任何条款被认定为无效或不可执行，不影响其他条款的效力。
开发者未行使或延迟行使其在本协议项下的任何权利，不应视为对该等权利的放弃。
如您对本协议有任何疑问，可通过 [400-808-5180] 与我们联系。`,
        'privacy.txt': `一、引言
本隐私政策（以下简称 "本政策"）旨在向您（以下简称 "用户"）说明 [眠加智能观心枕]（以下简称 "本小程序"）在收集、使用、存储、保护及对外提供用户个人信息时所遵循的原则和做法。
本政策是 [眠加智能观心枕] 用户协议的重要组成部分，与用户协议具有同等法律效力。用户在使用本小程序前，应仔细阅读并充分理解本政策的全部内容。用户点击 "同意" 或使用本小程序，即表示用户已同意本政策的全部条款，愿意接受本政策的约束。
开发者有权根据业务发展和法律法规的变化，对本政策进行修改。修改后的政策将在本小程序内公示，公示后即生效。用户如继续使用本小程序，视为接受修改后的政策；如不接受，应停止使用本小程序。
二、信息的收集与使用
基本信息：当用户注册本小程序账号时，为了完成账号注册及身份验证，我们可能会收集用户的手机号码、电子邮箱等信息。这些信息将用于用户账号的登录、找回密码、接收重要通知等功能。
使用信息：用户在使用本小程序的过程中，我们可能会收集用户的使用记录，包括但不限于浏览的页面、点击的功能、使用的时长等。这些信息将帮助我们了解用户的使用习惯，以便为用户提供更优质的服务和个性化的推荐。
设备信息：为了保障小程序的正常运行、提高服务安全性，我们可能会收集用户使用的设备相关信息，如设备型号、操作系统版本、设备标识符、网络状态等。
位置信息：若本小程序提供与位置相关的服务，且用户同意授权，我们会收集用户的位置信息。该信息仅用于为用户提供相应的位置服务，用户可随时通过小程序设置或设备系统设置关闭位置授权。
其他信息：在用户参与本小程序的活动、反馈意见或咨询问题时，我们可能会收集用户提供的相关信息，如姓名、地址、意见内容等，以便更好地为用户提供服务和解决问题。
三、信息的存储
我们将收集到的用户个人信息存储在符合安全标准的服务器中，并采取加密、访问控制等安全措施，防止信息被泄露、篡改或丢失。
用户个人信息的存储期限将根据法律法规的要求及业务需要确定。在存储期限届满后，我们将对用户的个人信息进行删除或匿名化处理。
我们可能会将用户的个人信息存储在中华人民共和国境内。如因业务需要将信息传输至境外，我们将按照相关法律法规的要求进行，并采取必要的安全措施保障信息的安全。
四、信息的保护
我们高度重视用户个人信息的安全，建立了完善的安全管理制度和技术防护体系，以防止用户信息被非法访问、使用、泄露等。
我们对接触用户个人信息的员工进行严格的管理和培训，明确其信息保护的责任和义务。
尽管我们采取了上述安全措施，但由于网络环境的复杂性和不确定性，我们不能完全保证用户个人信息的绝对安全。用户应妥善保管自己的账号及密码等信息，避免因自身原因导致信息泄露。
如发生用户个人信息泄露等安全事件，我们将立即采取补救措施，并按照相关法律法规的要求及时向用户和有关部门报告。
五、信息的对外提供
未经用户事先书面同意，我们不会将用户的个人信息泄露给任何第三方，除非法律法规另有规定或为了维护国家安全、公共利益等需要。
为了向用户提供更好的服务，我们可能会与合作伙伴共享用户的部分非个人身份信息，且该共享信息不会用于识别用户个人身份。在与合作伙伴共享信息前，我们会对合作伙伴进行严格的评估和监督，确保其遵守相关法律法规和保密义务。
如因合并、分立、收购、重组等原因导致用户个人信息的所有权或使用权发生转移，我们将提前通知用户，并要求接收方继续遵守本政策的规定，保护用户的个人信息。
六、用户的权利
查询与更正权：用户有权查询自己在本小程序中的个人信息。如发现个人信息存在错误，用户有权要求我们进行更正。
删除权：在符合法律法规规定的情况下，用户有权要求我们删除其个人信息。如用户注销账号，我们将对其相关个人信息进行删除或匿名化处理。
撤回同意权：用户有权撤回对本政策中关于信息收集、使用等方面的同意。用户可通过小程序设置或设备系统设置撤回相应的授权，但撤回同意可能会影响用户对本小程序部分功能的使用。
投诉与举报权：如用户认为我们在信息处理过程中存在违反本政策或相关法律法规的行为，有权向我们进行投诉或举报。我们将在收到投诉或举报后的 [7个工作日] 内进行处理并反馈结果。
七、未成年人信息保护
我们高度重视未成年人的信息保护。若用户为未成年人，其使用本小程序及提供个人信息应事先获得监护人的同意。
对于收集到的未成年人个人信息，我们将采取更加严格的保护措施，确保信息的安全。未成年人的监护人有权查阅、更正或删除未成年人在本小程序中的个人信息。
八、法律适用与争议解决
本政策的订立、效力、解释、履行及争议解决均适用中华人民共和国法律（不包括香港、澳门特别行政区和台湾地区的法律）。
因本政策引起的或与本政策有关的任何争议，双方应首先通过友好协商解决；协商不成的，任何一方均有权向开发者所在地有管辖权的人民法院提起诉讼。
九、其他
如您对本政策有任何疑问或建议，可通过 [400-808-5180] 与我们联系。
本政策自发布之日起生效。`
      };
      
      if (contentMap[filename]) {
        resolve(contentMap[filename]);
      } else {
        reject(new Error(`文件 ${filename} 不存在`));
      }
    });
  }

  /**
   * 获取协议标题
   * @param {string} type - 协议类型
   * @returns {string} 协议标题
   */
  getProtocolTitle(type) {
    if (!this.protocols[type]) {
      return '';
    }
    return this.protocols[type].title;
  }

  /**
   * 获取所有协议类型
   * @returns {Array} 协议类型列表
   */
  getProtocolTypes() {
    return Object.keys(this.protocols);
  }

  /**
   * 预加载所有协议内容
   * @returns {Promise} 加载结果
   */
  async preloadAllProtocols() {
    const promises = this.getProtocolTypes().map(type => 
      this.getProtocolContent(type).catch(error => {
        console.warn(`预加载协议 ${type} 失败:`, error);
        return null;
      })
    );

    try {
      await Promise.all(promises);
      console.log('所有协议预加载完成');
    } catch (error) {
      console.error('预加载协议失败:', error);
    }
  }

  /**
   * 清除缓存的协议内容
   */
  clearCache() {
    this.getProtocolTypes().forEach(type => {
      this.protocols[type].content = '';
    });
  }
}

module.exports = ProtocolManager; 